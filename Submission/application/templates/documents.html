{% extends "base.html" %}

{% block content %}
<h1>Document Submission</h1>

<div class="grid grid-2">
    <div class="card">
        <h2>Submit Document</h2>
        <form method="POST" action="{{ url_for('submit_document') }}" id="documentForm">
            <div class="form-group">
                <label for="customer_process">Select Customer & Process:</label>
                <select id="customer_process" name="customer_process" required onchange="updateRequiredDocs()">
                    <option value="">-- Select Customer & Process --</option>
                    {% for customer_data in customers_data %}
                    <option value="{{ customer_data.id }}-{{ customer_data.process_id }}">
                        {{ customer_data.name }} - {{ customer_data.process_name }}
                    </option>
                    {% endfor %}
                </select>
                <input type="hidden" id="customer_id" name="customer_id">
                <input type="hidden" id="process_id" name="process_id">
            </div>
            
            <div class="form-group">
                <label for="document_type_id">Document Type:</label>
                <select id="document_type_id" name="document_type_id" required onchange="updateRequiredFields()">
                    <option value="">-- Select Document Type --</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="file_url">File URL/Path:</label>
                <input type="text" id="file_url" name="file_url" placeholder="/uploads/document.pdf" required>
            </div>
            
            <div id="extractedDataSection" style="display: none;">
                <div class="form-group">
                    <label for="extracted_data">Extracted Data (JSON):</label>
                    <textarea id="extracted_data" name="extracted_data" rows="6" placeholder='{"field_name": "value"}'></textarea>
                    <small style="color: #666;">Enter the OCR extracted data in JSON format</small>
                </div>
            </div>
            
            <button type="submit" class="btn">Submit Document</button>
        </form>
    </div>
    
    <div class="card">
        <h2>Required Fields</h2>
        <div id="requiredFieldsInfo">
            <p style="color: #666;">Select a document type to see required fields</p>
        </div>
        
        <h3 style="margin-top: 30px;">Document Types</h3>
        {% for doc_type in document_types %}
        <div style="padding: 10px; background: #f8f9fa; margin: 5px 0; border-radius: 5px;">
            <strong>{{ doc_type.name }}</strong><br>
            <small style="color: #666;">{{ doc_type.description }}</small>
        </div>
        {% endfor %}
    </div>
</div>

<div class="card" style="margin-top: 30px;">
    <div class="recent-submissions mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>Recent Document Submissions</h2>
                <br>
            <div class="btn-group" role="group">
                <button class="btn btn-sm btn-outline-primary" onclick="refreshSubmissions()"><i class="fas fa-sync-alt"></i> Refresh</button>
                <button class="btn btn-sm btn-outline-secondary" onclick="filterSubmissions('all')">All</button>
                <button class="btn btn-sm btn-outline-warning" onclick="filterSubmissions('pending')">Pending</button>
                <button class="btn btn-sm btn-outline-success" onclick="filterSubmissions('approved')">Approved</button>
                <button class="btn btn-sm btn-outline-danger" onclick="filterSubmissions('rejected')">Rejected</button>
            </div>
    </div>
    
    <div class="table-responsive">
        <table class="table table-hover">
            <thead class="table-light">
                <tr>
                    <th>Customer</th>
                    <th>Process</th>
                    <th>Document Type</th>
                    <th>Upload Date</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="submissions-tbody">
                {% for submission in recent_submissions %}
                <tr class="submission-row" data-status="{{ submission.validation_status }}">
                    <td>
                        <div>
                            <strong>{{ submission.customer_name or submission.customer_email.split('@')[0]|title }}</strong>
                            {% if submission.customer_name != submission.customer_email.split('@')[0]|title %}
                            <br><small class="text-muted">{{ submission.customer_email }}</small>
                            {% endif %}
                        </div>
                    </td>
                    <td>{{ submission.process_name }}</td>
                    <td>
                        <span class="badge badge-info">{{ submission.document_type_name }}</span>
                    </td>
                    <td>
                        <small>{{ submission.upload_date[:16].replace('T', ' ') if submission.upload_date else 'N/A' }}</small>
                    </td>
                    <td>
                        <span class="status-badge badge 
                            {{ 'badge-success' if submission.validation_status == 'approved' 
                               else ('badge-warning' if submission.validation_status == 'pending' 
                               else 'badge-danger') }}">
                            <i class="fas {{ 'fa-check-circle' if submission.validation_status == 'approved' 
                                           else ('fa-clock' if submission.validation_status == 'pending' 
                                           else 'fa-times-circle') }}"></i>
                            {{ submission.validation_status|title }}
                        </span>
                    </td>
                    <td>
                        <div class="action-buttons">
                            <!-- View/Download button -->
                            {% if submission.file_url %}
                            <button class="btn btn-sm btn-outline-info" onclick="viewDocument('{{ submission.file_url }}')" title="View Document">
                                <i class="fas fa-eye"></i> View
                            </button>
                            {% endif %}
                            
                            <!-- Status change buttons -->
                            {% if submission.validation_status != 'approved' %}
                            <form style="display: inline;" method="POST" action="/update_document_status" 
                                  onsubmit="return confirmStatusChange('{{ submission.customer_name }}', '{{ submission.document_type_name }}', 'approved')">
                                <input type="hidden" name="submission_id" value="{{ submission.id }}">
                                <input type="hidden" name="new_status" value="approved">
                                <button type="submit" class="btn btn-sm btn-success" title="Approve Document">
                                    <i class="fas fa-check"></i> Approve
                                </button>
                            </form>
                            {% endif %}
                            
                            {% if submission.validation_status != 'pending' %}
                            <form style="display: inline;" method="POST" action="/update_document_status"
                                  onsubmit="return confirmStatusChange('{{ submission.customer_name }}', '{{ submission.document_type_name }}', 'pending')">
                                <input type="hidden" name="submission_id" value="{{ submission.id }}">
                                <input type="hidden" name="new_status" value="pending">
                                <button type="submit" class="btn btn-sm btn-warning" title="Set to Pending">
                                    <i class="fas fa-clock"></i>pending
                                </button>
                            </form>
                            {% endif %}
                            
                            {% if submission.validation_status != 'rejected' %}
                            <form style="display: inline;" method="POST" action="/update_document_status"
                                  onsubmit="return confirmStatusChange('{{ submission.customer_name }}', '{{ submission.document_type_name }}', 'rejected')">
                                <input type="hidden" name="submission_id" value="{{ submission.id }}">
                                <input type="hidden" name="new_status" value="rejected">
                                <button type="submit" class="btn btn-sm btn-danger" title="Reject Document">
                                    <i class="fas fa-times"></i>    Reject
                                </button>
                            </form>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        
        {% if not recent_submissions %}
        <div class="text-center py-4">
            <i class="fas fa-file-alt fa-3x text-muted mb-3"></i>
            <p class="text-muted">No document submissions yet.</p>
        </div>
        {% endif %}
    </div>
</div>

<style>
.recent-submissions {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 20px;
    margin-top: 20px;
}

.status-badge {
    font-size: 12px;
    padding: 6px 12px;
    border-radius: 15px;
    display: inline-flex;
    align-items: center;
    gap: 5px;
}

.action-buttons {
    display: flex;
    gap: 5px;
    justify-content: center;
}

.action-buttons .btn {
    min-width: 35px;
}

.table-hover tbody tr:hover {
    background-color: rgba(0,123,255,.075);
}

.badge-info {
    color: #17a2b8;
}

/* Filtering styles */
.submission-row.hidden {
    display: none;
}

/* Status-specific row highlighting */
.submission-row[data-status="approved"] {
    border-left: 4px solid #28a745;
}

.submission-row[data-status="pending"] {
    border-left: 4px solid #ffc107;
}

.submission-row[data-status="rejected"] {
    border-left: 4px solid #dc3545;
}
</style>

<script>
function confirmStatusChange(customerName, documentType, newStatus) {
    const messages = {
        'approved': `Are you sure you want to APPROVE the ${documentType} document for ${customerName}?`,
        'pending': `Are you sure you want to set the ${documentType} document for ${customerName} to PENDING?`,
        'rejected': `Are you sure you want to REJECT the ${documentType} document for ${customerName}?`
    };
    
    return confirm(messages[newStatus] || 'Are you sure you want to change the status?');
}

function viewDocument(fileUrl) {
    if (fileUrl) {
        // Open in new tab/window
        window.open(fileUrl, '_blank');
    } else {
        alert('Document URL not available');
    }
}

function refreshSubmissions() {
    // Add loading state
    const refreshBtn = document.querySelector('button[onclick="refreshSubmissions()"]');
    const originalHtml = refreshBtn.innerHTML;
    refreshBtn.innerHTML = '<i class="fas fa-spin fa-spinner"></i> Refreshing...';
    refreshBtn.disabled = true;
    
    // Reload the page after a short delay
    setTimeout(() => {
        window.location.reload();
    }, 500);
}

function filterSubmissions(status) {
    const rows = document.querySelectorAll('.submission-row');
    const buttons = document.querySelectorAll('.btn-group .btn');
    
    // Update button states
    buttons.forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    
    // Filter rows
    rows.forEach(row => {
        if (status === 'all') {
            row.classList.remove('hidden');
        } else {
            if (row.dataset.status === status) {
                row.classList.remove('hidden');
            } else {
                row.classList.add('hidden');
            }
        }
    });
    
    // Update visible count
    const visibleRows = document.querySelectorAll('.submission-row:not(.hidden)').length;
    const totalRows = rows.length;
    
    // Show/hide no results message
    const tbody = document.getElementById('submissions-tbody');
    let noResultsMsg = document.getElementById('no-results-filter');
    
    if (visibleRows === 0 && totalRows > 0) {
        if (!noResultsMsg) {
            noResultsMsg = document.createElement('tr');
            noResultsMsg.id = 'no-results-filter';
            noResultsMsg.innerHTML = '<td colspan="7" class="text-center py-4 text-muted">No submissions match the selected filter.</td>';
            tbody.appendChild(noResultsMsg);
        }
    } else if (noResultsMsg) {
        noResultsMsg.remove();
    }
}

// Auto-refresh submissions every 60 seconds
setInterval(function() {
    if (!document.hidden) {
        fetch(window.location.href)
            .then(response => response.text())
            .then(html => {
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const newTbody = doc.querySelector('#submissions-tbody');
                if (newTbody) {
                    document.querySelector('#submissions-tbody').innerHTML = newTbody.innerHTML;
                }
            })
            .catch(console.error);
    }
}, 60000); // 60 seconds

// Initialize filter - show all by default
document.addEventListener('DOMContentLoaded', function() {
    const allBtn = document.querySelector('button[onclick="filterSubmissions(\'all\')"]');
    if (allBtn) allBtn.classList.add('active');
});


function updateRequiredDocs() {
    const customerProcess = document.getElementById('customer_process').value;
    const documentTypeSelect = document.getElementById('document_type_id');
    
    if (!customerProcess) {
        documentTypeSelect.innerHTML = '<option value="">-- Select Document Type --</option>';
        return;
    }
    
    const [customerId, processId] = customerProcess.split('-');
    document.getElementById('customer_id').value = customerId;
    document.getElementById('process_id').value = processId;
    
    // Fetch required documents for this process
    fetch(`/get_required_documents?process_id=${processId}`)
        .then(response => response.json())
        .then(documents => {
            documentTypeSelect.innerHTML = '<option value="">-- Select Document Type --</option>';
            documents.forEach(doc => {
                const option = document.createElement('option');
                option.value = doc.id;
                option.textContent = doc.name;
                option.dataset.requiredFields = doc.required_fields;
                documentTypeSelect.appendChild(option);
            });
        });
}

function updateRequiredFields() {
    const select = document.getElementById('document_type_id');
    const selectedOption = select.options[select.selectedIndex];
    const requiredFieldsInfo = document.getElementById('requiredFieldsInfo');
    const extractedDataSection = document.getElementById('extractedDataSection');
    const extractedDataTextarea = document.getElementById('extracted_data');
    
    if (selectedOption.dataset.requiredFields) {
        const fields = JSON.parse(selectedOption.dataset.requiredFields);
        let fieldsHtml = '<h4>Required Fields:</h4><ul>';
        
        // Create sample JSON structure
        let sampleJson = {};
        for (const [field, type] of Object.entries(fields)) {
            fieldsHtml += `<li><strong>${field}</strong> (${type})</li>`;
            sampleJson[field] = type === 'string' ? 'sample_value' : 
                               type === 'number' ? 0 : 
                               type === 'date' ? '2024-01-01' : 'value';
        }
        
        fieldsHtml += '</ul>';
        requiredFieldsInfo.innerHTML = fieldsHtml;
        
        // Show extracted data section with sample
        extractedDataSection.style.display = 'block';
        extractedDataTextarea.placeholder = JSON.stringify(sampleJson, null, 2);
    } else {
        requiredFieldsInfo.innerHTML = '<p style="color: #666;">Select a document type to see required fields</p>';
        extractedDataSection.style.display = 'none';
    }
}


</script>
{% endblock %}